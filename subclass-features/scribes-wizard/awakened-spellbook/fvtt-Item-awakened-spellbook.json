{
  "name": "Awakened Spellbook",
  "type": "feat",
  "img": "icons/sundries/books/book-clasp-spiral-green.webp",
  "data": {
    "description": {
      "value": "<p>Using specially prepared inks and ancient incantations passed down by your wizardly order, you have awakened an arcane sentience within your spellbook.</p>\n<p>While you are holding the book, it grants you the following benefits:</p>\n<ul>\n<li>You can use the book as a spellcasting focus for your wizard spells.</li>\n<li>When you cast a wizard spell with a spell slot, you can temporarily replace its damage type with a type that appears in another spell in your spellbook, which magically alters the spell’s formula for this casting only. The latter spell must be of the same level as the spell slot you expend.</li>\n<li>When you cast a wizard spell as a ritual, you can use the spell’s normal casting time, rather than adding 10 minutes to it. Once you use this benefit, you can’t do so again until you finish a long rest.</li>\n</ul>\n<p>If necessary, you can replace the book over the course of a short rest by using your Wizardly Quill to write arcane sigils in a blank book or a magic spellbook to which you’re attuned. At the end of the rest, your spellbook’s consciousness is summoned into the new book, which the consciousness transforms into your spellbook, along with all its spells. If the previous book still existed somewhere, all the spells vanish from its pages.</p>",
      "chat": "",
      "unidentified": ""
    },
    "source": "",
    "activation": {
      "type": "",
      "cost": 0,
      "condition": ""
    },
    "duration": {
      "value": null,
      "units": ""
    },
    "target": {
      "value": null,
      "width": null,
      "units": "",
      "type": ""
    },
    "range": {
      "value": null,
      "long": null,
      "units": ""
    },
    "uses": {
      "value": null,
      "max": "",
      "per": null
    },
    "consume": {
      "type": "",
      "target": null,
      "amount": null
    },
    "ability": null,
    "actionType": "",
    "attackBonus": 0,
    "chatFlavor": "",
    "critical": {
      "threshold": null,
      "damage": ""
    },
    "damage": {
      "parts": [],
      "versatile": ""
    },
    "formula": "",
    "save": {
      "ability": "",
      "dc": null,
      "scaling": "spell"
    },
    "requirements": "",
    "recharge": {
      "value": null,
      "charged": false
    },
    "attunement": null
  },
  "effects": [
    {
      "_id": "zL2DYd7BrI7yItAH",
      "changes": [
        {
          "key": "flags.midi-qol.onUseMacroName",
          "mode": 0,
          "value": "ItemMacro.Awakened Spellbook, preambleComplete",
          "priority": "20"
        }
      ],
      "disabled": false,
      "duration": {
        "startTime": null
      },
      "icon": "icons/sundries/books/book-clasp-spiral-green.webp",
      "label": "Awakened Spellbook",
      "origin": "Item.jOq2TPQRLrzI9RLK",
      "transfer": true,
      "flags": {
        "dae": {
          "selfTarget": false,
          "stackable": "none",
          "durationExpression": "",
          "macroRepeat": "none",
          "specialDuration": [],
          "transfer": true
        },
        "core": {
          "statusId": ""
        },
        "dnd5e-helpers": {
          "rest-effect": "Ignore"
        },
        "ActiveAuras": {
          "isAura": false,
          "aura": "None",
          "radius": null,
          "alignment": "",
          "type": "",
          "ignoreSelf": false,
          "height": false,
          "hidden": false,
          "displayTemp": false,
          "hostile": false,
          "onlyOnce": false
        }
      },
      "tint": null,
      "selectedKey": "flags.midi-qol.onUseMacroName"
    }
  ],
  "flags": {
    "scene-packer": {
      "hash": "f3c6d1875f85b8221c380254c133e2979c6c2b17",
      "sourceId": "Item.Y9iAci5U8HSd2eSf"
    },
    "itemacro": {
      "macro": {
        "_id": null,
        "name": "Awakened Spellbook",
        "type": "script",
        "author": "ckiTPzlaPztdkjV6",
        "img": "icons/svg/dice-target.svg",
        "scope": "global",
        "command": "// awakened spellbook\n// onusemacroname preambleComplete\n\nconst lastArg = args[args.length - 1];\nconst tokenOrActor = await fromUuid(lastArg.actorUuid);\nconst tactor = tokenOrActor.actor ? tokenOrActor.actor : tokenOrActor;\nif (args[0].tag === \"OnUse\" && args[0].item.type === \"spell\" && args[0].spellLevel > 0 && args[0].item.data.damage.parts.length > 0) {\n    const validTypes = [\"acid\", \"bludgeoning\", \"cold\", \"fire\", \"force\", \"lightning\", \"necrotic\", \"piercing\", \"poison\", \"psychic\", \"radiant\", \"slashing\", \"thunder\"];\n    if (!validTypes.some(type => args[0].item.data.damage.parts[0][1]?.toLowerCase() === type)) return;\n    const optionTypes = [];\n    tactor.data.items.forEach(i => {\n        if (i.type === \"spell\" && i.data.data.level === args[0].spellLevel) {\n            validTypes.forEach(t => {\n                if (optionTypes.includes(t)) return;\n                if (i.data.data.description.value?.toLowerCase().includes(t)) optionTypes.push(t);\n            });\n        }\n    });\n    if (optionTypes.length === 0) return;\n    const optionContent = optionTypes.map((o) => { return `<option value=\"${o}\">${CONFIG.DND5E.damageTypes[o]}</option>` })\n    const content = `\n        <div class=\"form-group\">\n        <label>Damage Types : </label>\n        <select name=\"types\"}>\n        ${optionContent}\n        </select>\n        </div>\n    `;\n    let dialog = new Promise((resolve, reject) => {\n        new Dialog({\n            title: \"Awakened Spellbook: Replace Damage Type?\",\n            content,\n            buttons: {\n                Confirm: {\n                    label: \"Confirm\",\n                    callback: (html) => {resolve(html.find(\"[name=types]\")[0].value)},\n                },\n                Cancel: {\n                    label: \"Cancel\",\n                    callback: () => {resolve(false)},\n                },\n            },\n            default: \"Cancel\",\n            close: () => {resolve(false)}\n        }).render(true);\n    });\n    let type = await dialog;\n    if (!type) return;\n    const workflow = MidiQOL.Workflow.getWorkflow(args[0].uuid);\n    workflow.defaultDamageType = type;\n    const parts = workflow.item.data.data.damage.parts;\n    workflow.item.data.data.damage.parts.forEach(part => {\n        part[0] = part[0].replace(/\\[(.*)\\]/g, `[${type}]`);\n        part[1] = type;\n    });\n    let hook = Hooks.on(\"midi-qol.RollComplete\", async workflowNext => {\n        if (workflowNext.uuid === args[0].uuid) {\n            const workflowItem = await fromUuid(workflow.item.uuid);\n            workflowItem.update({ \"data.data.damage.parts\" : parts });\n            Hooks.off(\"midi-qol.RollComplete\", hook);\n        }\n    });\n}",
        "folder": null,
        "sort": 0,
        "permission": {
          "default": 0
        },
        "flags": {}
      }
    },
    "core": {
      "sourceId": "Item.jOq2TPQRLrzI9RLK"
    },
    "exportSource": {
      "world": "dnd5e",
      "system": "dnd5e",
      "coreVersion": "9.280",
      "systemVersion": "1.6.3"
    }
  }
}