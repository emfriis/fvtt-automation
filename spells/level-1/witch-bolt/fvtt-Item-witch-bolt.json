{
  "name": "Witch Bolt",
  "type": "spell",
  "img": "systems/dnd5e/icons/spells/lighting-royal-2.jpg",
  "data": {
    "description": {
      "value": "<p>A beam of crackling, blue energy lances out toward a creature within range, forming a sustained arc of lightning between you and the target. Make a ranged spell attack against that creature. On a hit, the target takes 1d12 lightning damage, and on each of your turns for the duration, you can use your action to deal 1d12 lightning damage to the target automatically. The spell ends if you use your action to do anything else. The spell also ends if the target is ever outside the spell’s range or if it has total cover from you.</p>\n<p><strong>At Higher Levels. </strong>When you cast this spell using a spell slot of 2nd level or higher, the initial damage increases by 1d12 for each slot level above 1st.</p>",
      "chat": "",
      "unidentified": ""
    },
    "source": "Player's Handbook pg 289",
    "activation": {
      "type": "action",
      "cost": 1,
      "condition": ""
    },
    "duration": {
      "value": 1,
      "units": "minute"
    },
    "target": {
      "value": 1,
      "width": null,
      "units": "",
      "type": "creature"
    },
    "range": {
      "value": 30,
      "long": null,
      "units": "ft"
    },
    "uses": {
      "value": null,
      "max": "",
      "per": ""
    },
    "consume": {
      "type": "",
      "target": "",
      "amount": null
    },
    "ability": "",
    "actionType": "rsak",
    "attackBonus": "0",
    "chatFlavor": "",
    "critical": {
      "threshold": null,
      "damage": ""
    },
    "damage": {
      "parts": [
        [
          "1d12[lightning]",
          "lightning"
        ]
      ],
      "versatile": ""
    },
    "formula": "",
    "save": {
      "ability": "",
      "dc": null,
      "scaling": "spell"
    },
    "level": 1,
    "school": "evo",
    "components": {
      "value": "a twig from a tree that has been struck by lightning",
      "vocal": true,
      "somatic": true,
      "material": true,
      "ritual": false,
      "concentration": true
    },
    "materials": {
      "value": "a twig from a tree that has been struck by lightning",
      "consumed": false,
      "cost": 0,
      "supply": 0
    },
    "preparation": {
      "mode": "prepared",
      "prepared": false
    },
    "scaling": {
      "mode": "level",
      "formula": "1d12"
    }
  },
  "effects": [
    {
      "label": "Witch Bolt",
      "icon": "systems/dnd5e/icons/spells/lighting-royal-2.jpg",
      "changes": [
        {
          "key": "macro.itemMacro",
          "value": "",
          "mode": 0,
          "priority": 20
        }
      ],
      "duration": {
        "startTime": null
      },
      "tint": null,
      "transfer": false,
      "disabled": false,
      "flags": {
        "dae": {
          "transfer": false,
          "stackable": "none"
        },
        "ddbimporter": {
          "disabled": false
        },
        "midi-qol": {
          "forceCEOff": true
        }
      },
      "_id": "a832czgezod2p7do"
    }
  ],
  "flags": {
    "ddbimporter": {
      "id": 138953,
      "definitionId": 2323,
      "entityTypeId": 435869154,
      "dndbeyond": {
        "lookup": "generic",
        "lookupName": "generic",
        "level": null,
        "castAtLevel": null
      },
      "originalName": "Witch Bolt",
      "sources": [
        {
          "sourceId": 2,
          "pageNumber": 289,
          "sourceType": 1
        }
      ],
      "tags": [
        "Damage"
      ],
      "version": "2.9.64",
      "effectsApplied": true
    },
    "itemacro": {
      "macro": {
        "data": {
          "_id": null,
          "name": "Witch Bolt",
          "type": "script",
          "author": "otqBqyqMuTGDffTr",
          "img": "icons/svg/dice-target.svg",
          "scope": "global",
          "command": "const lastArg = args[args.length - 1];\nconst sourceItem = await fromUuid(lastArg.origin);\nconst caster = sourceItem.parent;\nconst damageType = \"lightning\";\nconst parentEffectName = \"WitchBolt (Concentration)\";\nconst hasParentEffect = caster.effects.some((e) => e.data.label === parentEffectName);\n\nasync function checkTargetInRange({ sourceUuid, targetUuid, distance }) {\n  const sourceToken = await fromUuid(sourceUuid);\n  if (!sourceToken) return false;\n  const targetsInRange = MidiQOL.findNearby(null, sourceToken, distance, null);\n  const isInRange = targetsInRange.reduce((result, possible) => {\n    const collisionRay = new Ray(sourceToken, possible);\n    const collision = canvas.walls.checkCollision(collisionRay);\n    if (possible.uuid === targetUuid && !collision) result = true;\n    return result;\n  }, false);\n  return isInRange;\n}\n\nasync function sustainedDamage(options) {\n  const damageRoll = await new Roll(`1d12[${damageType}]`).evaluate({ async: true });\n  if (game.dice3d) game.dice3d.showForRoll(damageRoll, game.users.get(options.userId));\n\n  const targets = await Promise.all(options.targets.map(async (uuid) => await fromUuid(uuid)));\n  const casterToken = await fromUuid(options.sourceUuid);\n  const itemData = sourceItem.toObject();\n  setProperty(itemData, \"data.components.concentration\", false);\n  new MidiQOL.DamageOnlyWorkflow(\n    caster,\n    casterToken,\n    damageRoll.total,\n    damageType,\n    targets,\n    damageRoll,\n    {\n      flavor: `(${CONFIG.DND5E.damageTypes[damageType]})`,\n      itemCardId: \"new\",\n      itemData: itemData,\n      isCritical: false,\n    }\n  );\n\n}\n\nasync function cancel() {\n  const concentration = caster.effects.find((i) => i.data.label === \"Concentrating\");\n  if (concentration) {\n    await MidiQOL.socket().removeEffects({ actorUuid: caster.uuid, effects: [concentration.id] });\n  }\n  await DAE.unsetFlag(caster, \"witchBoltSpell\");\n}\n\nif (args[0] === \"on\" && !hasParentEffect && caster.uuid !== lastArg.actorUuid) {\n  // create caster round-by-round damage effect\n  const sourceItem = await fromUuid(lastArg.origin);\n  const effectData = [{\n    label: parentEffectName,\n    icon: sourceItem.img,\n    duration: { rounds: 10, startTime: game.time.worldTime },\n    origin: lastArg.origin,\n    changes: [{\n      key: \"macro.itemMacro.local\",\n      value: \"\",\n      mode: CONST.ACTIVE_EFFECT_MODES.CUSTOM,\n      priority: 20,\n    }],\n    disabled: false,\n    \"flags.dae.macroRepeat\": \"startEveryTurn\",\n  }];\n\n  const targets = [];\n  for (let t of game.user.targets) {\n    targets.push(t.document.uuid);\n  }\n  const casterToken = canvas.tokens.placeables.find((t) => t.actor?.id === caster.id);\n  const options = {\n    targets,\n    sourceUuid: casterToken?.document?.uuid,\n    distance: sourceItem.data.data.range.value,\n    userId: game.userId,\n  };\n  DAE.setFlag(caster, \"witchBoltSpell\", options);\n  await caster.createEmbeddedDocuments(\"ActiveEffect\", effectData);\n} else if (args[0] == \"off\") {\n  DAE.unsetFlag(caster, \"witchBoltSpell\");\n} else if (args[0] == \"each\") {\n  const options = DAE.getFlag(caster, \"witchBoltSpell\");\n  const isOn = await checkTargetInRange(options);\n  if (isOn) {\n    new Dialog({\n      title: sourceItem.name,\n      content: \"<p>Use action to sustain Witch Bolt?</p>\",\n      buttons: {\n        continue: {\n          label: \"Sustain\",\n          callback: () => sustainedDamage(options)\n        },\n        end: {\n          label: \"End concentration\",\n          callback: () => cancel()\n        }\n      }\n    }).render(true);\n  }\n}",
          "folder": null,
          "sort": 0,
          "permission": {
            "default": 0
          },
          "flags": {}
        }
      }
    },
    "core": {
      "sourceId": "Compendium.world.ddb-spells-2.J6M8dvwZ7axyhqcF"
    },
    "scene-packer": {
      "hash": "1c43c4dd67846459bf6fa6269e46f34328851afe",
      "sourceId": "Item.UGonfpI7S64QityZ"
    },
    "rest-recovery": {
      "data": {
        "recovery": {
          "enabled": false
        }
      }
    },
    "midi-qol": {
      "fumbleThreshold": null,
      "effectActivation": false
    },
    "midiProperties": {
      "nodam": false,
      "fulldam": false,
      "halfdam": false,
      "rollOther": false,
      "critOther": false,
      "magicdam": false,
      "magiceffect": false,
      "concentration": false,
      "toggleEffect": false
    },
    "exportSource": {
      "world": "Curse of Strahd",
      "system": "dnd5e",
      "coreVersion": "9.280",
      "systemVersion": "1.6.3"
    }
  }
}