{
  "name": "Shadow of Moil",
  "type": "spell",
  "img": "icons/commodities/gems/pearl-swirl-teal.webp",
  "data": {
    "description": {
      "value": "<p class=\"Core-Styles_Core-Body\">Flame-like shadows wreathe your body until the spell ends, causing you to become heavily obscured to others. The shadows turn dim light within 10 feet of you into darkness, and bright light in the same area to dim light.</p>\n<p class=\"Core-Styles_Core-Body\">Until the spell ends, you have resistance to radiant damage. In addition, whenever a creature within 10 feet of you hits you with an attack, the shadows lash out at that creature, dealing it 2d8 necrotic damage.</p>",
      "chat": "",
      "unidentified": ""
    },
    "source": "Xanathar's Guide to Everything pg 164",
    "activation": {
      "type": "action",
      "cost": 1,
      "condition": ""
    },
    "duration": {
      "value": 1,
      "units": "minute"
    },
    "target": {
      "value": null,
      "width": null,
      "units": "",
      "type": "self"
    },
    "range": {
      "value": null,
      "long": null,
      "units": ""
    },
    "uses": {
      "value": null,
      "max": "",
      "per": ""
    },
    "consume": {
      "type": "",
      "target": "",
      "amount": null
    },
    "ability": "",
    "actionType": "other",
    "attackBonus": 0,
    "chatFlavor": "",
    "critical": {
      "threshold": null,
      "damage": ""
    },
    "damage": {
      "parts": [],
      "versatile": ""
    },
    "formula": "",
    "save": {
      "ability": "",
      "dc": null,
      "scaling": "spell"
    },
    "level": 4,
    "school": "nec",
    "components": {
      "value": "an undead eyeball encased in a gem worth at least 150 gp",
      "vocal": true,
      "somatic": true,
      "material": true,
      "ritual": false,
      "concentration": true
    },
    "materials": {
      "value": "an undead eyeball encased in a gem worth at least 150 gp",
      "consumed": false,
      "cost": 150,
      "supply": 0
    },
    "preparation": {
      "mode": "prepared",
      "prepared": false
    },
    "scaling": {
      "mode": "none",
      "formula": ""
    },
    "attunement": 0
  },
  "effects": [
    {
      "_id": "1EXMLyX9eitwUMXt",
      "changes": [
        {
          "key": "data.traits.dr.value",
          "mode": 2,
          "value": "radiant",
          "priority": "20"
        },
        {
          "key": "ATL.light.dim",
          "mode": 5,
          "value": "-10",
          "priority": "20"
        },
        {
          "key": "ATL.light.alpha",
          "mode": 5,
          "value": "0.25",
          "priority": "20"
        },
        {
          "key": "flags.midi-qol.grants.disadvantage.attack.all",
          "mode": 0,
          "value": "1",
          "priority": "20"
        },
        {
          "key": "flags.midi-qol.advantage.attack.all",
          "mode": 0,
          "value": "1",
          "priority": "20"
        },
        {
          "key": "ATCV.obscured",
          "mode": 0,
          "value": "1",
          "priority": "20"
        },
        {
          "key": "ATCV.conditionType",
          "mode": 0,
          "value": "condition",
          "priority": "20"
        },
        {
          "key": "ATCV.conditionTargets",
          "mode": 0,
          "value": "",
          "priority": "20"
        },
        {
          "key": "ATCV.conditionSources",
          "mode": 0,
          "value": "blindsight,tremorsense",
          "priority": "20"
        },
        {
          "key": "macro.itemMacro",
          "mode": 0,
          "value": "",
          "priority": "20"
        }
      ],
      "disabled": false,
      "duration": {
        "startTime": null
      },
      "icon": "icons/commodities/gems/pearl-swirl-teal.webp",
      "label": "Shadow of Moil",
      "origin": "Item.l1EZrxufuTu37222",
      "transfer": false,
      "flags": {
        "dae": {
          "selfTarget": false,
          "stackable": "none",
          "durationExpression": "",
          "macroRepeat": "none",
          "specialDuration": [],
          "transfer": false
        },
        "core": {
          "statusId": ""
        },
        "dnd5e-helpers": {
          "rest-effect": "Ignore"
        },
        "ActiveAuras": {
          "isAura": false,
          "aura": "None",
          "radius": null,
          "alignment": "",
          "type": "",
          "ignoreSelf": false,
          "height": false,
          "hidden": false,
          "displayTemp": false,
          "hostile": false,
          "onlyOnce": false
        }
      },
      "tint": null,
      "selectedKey": [
        "data.traits.dr.value",
        "ATL.light.dim",
        "ATL.light.alpha",
        "flags.midi-qol.grants.disadvantage.attack.all",
        "flags.midi-qol.advantage.attack.all",
        "__",
        "__",
        "__",
        "__",
        "macro.itemMacro"
      ]
    }
  ],
  "flags": {
    "ddbimporter": {
      "id": 138228,
      "definitionId": 14596,
      "entityTypeId": 435869154,
      "dndbeyond": {
        "lookup": "generic",
        "lookupName": "generic",
        "level": null,
        "castAtLevel": null
      },
      "originalName": "Shadow of Moil",
      "sources": [
        {
          "sourceId": 27,
          "pageNumber": 164,
          "sourceType": 1
        }
      ],
      "tags": [
        "Damage",
        "Buff"
      ],
      "version": "2.9.59",
      "effectsApplied": true
    },
    "betterRolls5e": {
      "quickVersatile": {
        "altValue": true
      },
      "quickCharges": {
        "value": {
          "use": true,
          "resource": true
        },
        "altValue": {
          "use": true,
          "resource": true
        }
      }
    },
    "core": {
      "sourceId": "Compendium.world.ddb-spells.At3evbO9Z9oRWHHK"
    },
    "midi-qol": {
      "effectActivation": false
    },
    "midiProperties": {
      "nodam": false,
      "fulldam": false,
      "halfdam": false,
      "rollOther": false,
      "critOther": false,
      "magicdam": false,
      "magiceffect": false,
      "concentration": false,
      "toggleEffect": false
    },
    "rest-recovery": {
      "data": {
        "recovery": {
          "enabled": false
        }
      }
    },
    "itemacro": {
      "macro": {
        "data": {
          "_id": null,
          "name": "Shadow of Moil",
          "type": "script",
          "author": "otqBqyqMuTGDffTr",
          "img": "icons/svg/dice-target.svg",
          "scope": "global",
          "command": "// shadow of moil\n\nconst lastArg = args[args.length - 1];\nconst token = await fromUuid(lastArg.tokenUuid);\nconst targetToken = canvas.tokens.get(lastArg.tokenId);\nconst tokenOrActor = await fromUuid(lastArg.actorUuid);\nconst tactor = tokenOrActor.actor ?? tokenOrActor;\n\nasync function wait(ms) { return new Promise(resolve => { setTimeout(resolve, ms); }); }\n\nasync function cleanUp() {\n\tconst flag = await DAE.getFlag(tactor, \"somHook\");\n\tif (flag) {\n\t\tHooks.off(\"midi-qol.preDamageRoll\", flag);\n\t\tawait DAE.unsetFlag(tactor, \"somHook\");\n\t}\n}\n\nasync function applyDamage(target) {\n  const item = await fromUuid(lastArg.efData.origin);\n\n  const caster = item.parent;\n  const casterToken = canvas.tokens.placeables.find((t) => t.actor?.uuid === caster.uuid);\n  const damageRoll = await new Roll(`2d8[necrotic]`).evaluate({ async: true });\n  if (game.dice3d) game.dice3d.showForRoll(damageRoll);\n  const workflowItemData = duplicate(item.data);\n  workflowItemData.data.components.concentration = false;\n  workflowItemData.data.duration = { value: null, units: \"inst\" };\n  workflowItemData.data.target = { value: null, width: null, units: \"\", type: \"creature\" };\n\n  setProperty(workflowItemData, \"flags.itemacro\", {});\n  setProperty(workflowItemData, \"flags.midi-qol\", {});\n  setProperty(workflowItemData, \"flags.dae\", {});\n  setProperty(workflowItemData, \"effects\", []);\n  delete workflowItemData._id;\n  workflowItemData.name = `${workflowItemData.name}`;\n  // console.warn(\"workflowItemData\", workflowItemData);\n\n  await new MidiQOL.DamageOnlyWorkflow(\n    caster,\n    casterToken.data,\n    damageRoll.total,\n    \"necrotic\",\n    [target],\n    damageRoll,\n    {\n      flavor: `(${CONFIG.DND5E.damageTypes[\"necrotic\"]})`,\n      itemCardId: \"new\",\n      itemData: workflowItemData,\n      isCritical: false,\n    }\n  );\n}\n\nasync function hitCheck(workflow) {\n    await wait(500);\n\tif (lastArg.tokenUuid != workflow.tokenUuid) {\n\t\tlet attacker = await fromUuid(workflow.tokenUuid);\n\t\tlet attackerToken = canvas.tokens.get(workflow.tokenId);\n\t\tif ((lastArg.tokenUuid) in (workflow.hitDisplayData) && workflow.hitDisplayData[`${lastArg.tokenUuid}`].hitString == \"hits\" && MidiQOL.getDistance(targetToken, attackerToken, false) <= 10 && [\"rwak\", \"rsak\", \"mwak\", \"msak\"].includes(workflow.item.data.data.actionType)) {\n\t\t\tapplyDamage(attacker);\n\t\t}\n\t}\n}\n\nif (args[0] == \"on\") {\n\tlet hookId = Hooks.on(\"midi-qol.preDamageRoll\", hitCheck);\n    DAE.setFlag(tactor, \"somHook\", hookId);\n}\n\nif (args[0] == \"off\") {\n\tawait cleanUp();\n}",
          "folder": null,
          "sort": 0,
          "permission": {
            "default": 0
          },
          "flags": {}
        }
      }
    },
    "scene-packer": {
      "sourceId": "Item.awbTmL0ob0iDMcB8",
      "hash": "6408530569a079ad1b9cc6d1c7291afac642ef95"
    },
    "exportSource": {
      "world": "Curse of Strahd",
      "system": "dnd5e",
      "coreVersion": "9.280",
      "systemVersion": "1.6.3"
    }
  }
}